<?php session_start();ini_set('display_errors',1);ini_set('display_startup_errors',1);error_reporting(E_ALL);require_once "../../database.php";require_once "../../tables.php";$db=Database::Instance();if($_SERVER["REQUEST_METHOD"]=="POST"){$pre=preg_replace('/[^A-Za-z0-9\-]/','-',$_POST['slug']);$slug=preg_replace('/-+/','-',$pre);$id=$_POST["id"];$d=$db->CustomQuery("SELECT slug FROM {$event_table} WHERE id={$id}");$sl=$d[0]->slug;$gets=$db->CustomQuery("SELECT * FROM slugs WHERE slug='{$sl}'");if(empty($gets)){$params=['page_name'=>'events','slug'=>$sl];$db->Insert($slugs_table,$params);}$img_url=$_POST["img_url"];$image_name=$_FILES["eventimage"]["name"];if(empty($image_name)){$insert_params=['title'=>$_POST['title'],'slug'=>$slug,'date'=>$_POST['date'],'meta_title'=>$_POST['meta_title'],'meta_description'=>$_POST['meta_description'],'intro_text'=>$_POST['introtextckediter'],'description'=>$_POST['detailckediter'],'video'=>$_POST['video'],'status'=>$_POST['status']];}else{$image=$_FILES["eventimage"]["tmp_name"];move_uploaded_file($image,"$image_name");$originalImage=null;$ext=strtolower(pathinfo($image_name,PATHINFO_EXTENSION));if($ext==='jpg'||$ext==='jpeg'){$originalImage=imagecreatefromjpeg("$image_name");}else if($ext==='png'){$originalImage=imagecreatefrompng("$image_name");}else if($ext==='gif'){$originalImage=imagecreatefromgif("$image_name");}if($originalImage===false){exit;}$originalWidth=imagesx($originalImage);$originalHeight=imagesy($originalImage);$resizedImage=imagecreatetruecolor($originalWidth,$originalHeight);imagecopyresampled($resizedImage,$originalImage,0,0,0,0,$originalWidth,$originalHeight,$originalWidth,$originalHeight);$new_img=uniqid("IMG-",TRUE);$new_img_name="{$new_img}.webp";$webp_path="../../../public/uploads/events/{$new_img_name}";$imgpath="../../../public/";imagewebp($resizedImage,$webp_path,80);imagedestroy($resizedImage);imagedestroy($originalImage);unlink("{$image_name}");unlink($imgpath.$img_url);$insert_params=['title'=>$_POST['title'],'slug'=>$slug,'date'=>$_POST['date'],'meta_title'=>$_POST['meta_title'],'meta_description'=>$_POST['meta_description'],'intro_text'=>$_POST['introtextckediter'],'description'=>$_POST['detailckediter'],'video'=>$_POST['video'],'image'=>"uploads/events/$new_img_name",'status'=>$_POST['status']];}if($db->Update($event_table,$insert_params,"id",[$id])){$params=['page_name'=>'events','slug'=>$slug];$db->Update($slugs_table,$params,"slug",[$sl]);$_SESSION['message']='EVENTS Edited Successfully';echo '<script type="text/javascript">';echo 'window.location.href="https://www.consultancynepal.com/cnbackend/showevents";';echo '</script>';die();}else{$_SESSION['messages']='EVENTS Edited failed';echo '<script type="text/javascript">';echo 'window.location.href="https://www.consultancynepal.com/cnbackend/showevents";';echo '</script>';die();header("location:https://www.consultancynepal.com/cnbackend/showbanner");}}